name: Sync with upstream

on:
  schedule:
    - cron: '0 0 * * *'  # 每天凌晨0点执行（UTC时间，可根据需要调整）
  workflow_dispatch:  # 允许手动触发

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # 拉取所有历史记录
          persist-credentials: true  # 保留凭证用于推送

      - name: Set up Git
        run: |
          git config --global user.name "五味杂陈"
          git config --global user.email "1162817775@qq.com"

      - name: Add upstream repository
        run: |
          if ! git remote | grep -q upstream; then
            git remote add upstream https://github.com/EOP-Labs/M2TWEOP-library.git
          fi
          git remote -v

      - name: Fetch upstream changes
        run: |
          git fetch upstream
          git branch -r

      - name: Merge upstream changes (handle modify/delete conflict)
        run: |
          # 切换到master并拉取最新本地代码
          git checkout master
          git pull origin master

          # 尝试合并上游分支
          if git merge upstream/master --no-edit; then
            echo "Merge successful, pushing to origin..."
            git push origin master
          else
            echo "Merge conflict detected! Handling conflicts..."
            git status

            # 处理globals.txt的modify/delete冲突：恢复上游版本（保留文件）
            # 如果你想保留删除（不恢复文件），将 --theirs 改为 --ours
            if git ls-files --unmerged | grep -q "globals.txt"; then
              echo "Resolving globals.txt modify/delete conflict (restore upstream version)..."
              git checkout --theirs "M2TWEOP DataFiles/eopData/eopScripts/globals.txt"
              git add "M2TWEOP DataFiles/eopData/eopScripts/globals.txt"
            fi

            # 检查是否还有其他未解决的冲突
            if git ls-files --unmerged | grep -q .; then
              echo "Other conflicts found, aborting merge (please resolve manually)..."
              git merge --abort
              exit 1
            else
              echo "All conflicts resolved, committing and pushing..."
              git commit -m "Resolve merge conflict: restore globals.txt from upstream"
              git push origin master
            fi
          fi
